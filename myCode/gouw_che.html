<!DOCTYPE html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<html>   
<head> 
<meta charset="utf-8">
<title>WangID通城——购物车</title>
<link rel="stylesheet" type="text/css" href="css/index.css">
<link rel="stylesheet" type="text/css" href="css/ziy.css">
</head>
<body>
<!--头部-->
<div id="header">
	<div class="header-box">
		<h3 class="huany">WangID本地购物商城欢迎您的到来！</h3>
		<ul class="header-left">
			<li class="bj">
				<a class="dib" href="#">贵阳市</a>
				<i class="ci-leftll">
					<s class="jt">◇</s>
				</i>
				<div class="bj-1">
					<h3>热门城市：</h3>
					<a href="">北京</a><a href="">上海</a><a href="">天津</a><a href="">重庆</a><a href="">河北</a><a href="">山西</a><a href="">河南</a><a href="">辽宁</a><a href="">吉林</a><a href="">黑龙江</a><a href="">浙江</a><a href="">江苏</a><a href="">山东</a><a href="">安徽</a><a href="">内蒙古</a><a href="">湖北</a><a href="">湖南</a><a href="">广东</a><a href="">广西</a><a href="">江西</a><a href="">四川</a><a href="">海南</a><a href="">贵州</a><a href="">云南</a><a href="">西藏</a><a href="">陕西</a><a href="">甘肃</a><a href="">青海</a><a href="">宁夏</a><a href="">新疆</a><a href="">台湾</a><a href="">香港</a><a href="">澳门</a><a href="">海外</a><a href="qieh_cs.html">全部+</a>
				</div>
			</li>					
		</ul>
		<ul class="header-right">
			<li class="denglu dengl_hou">
				<div>
					<a class="red" href="dengl.html">Hi~山的那边是海</a>
					<i class="icon_plus_nickname"></i>
					<i class="ci-leftll">
						<s class="jt">◇</s>
					</i>
				</div>
				<div class="dengl_hou_xial_k">
					<div class="zuid_xiao_toux">
						<a href="#"><img src="images/toux.png"></a>
					</div>
					<div class="huiy_dengj"> 
						<a class="tuic_" href="#">退出</a>
					</div>
					<div class="toub_zil_daoh">
						<a href="#">待处理订单</a>
						<a href="#">我的收藏</a>
						<a href="#">个人资料</a> 
					</div>
				</div>
				</li> 
			<li class="shu"></li>
			<li class="denglu"><a class="ing_ps" href="#">我的收藏</a></li>
			<li class="shu"></li>
			<li class="denglu"><a class="ing_ps ps1" href="#">申请入驻</a></li>
			<li class="shu"></li>
			<li class="denglu"><a class="ing_ps ps2" href="#">客户服务</a></li>
			<li class="shu"></li>	        
			<li class="shouji bj">
				<a class="ing_ps ps3" href="#">手机通城</a>
				<i class="ci-right ">
					<s class="jt">◇</s>
				</i>
				<div class="shouji1">
					<img src="images/mb_wangid.png" class="shouji4">
					<div class="shouji2">
						<p>通城客户端</p>
						<p class="red">首次下单满79元，送79元</p>
					</div>
					<div class="yi">
						<img src="images/mb_wangid.png" class="shouji4">
						<div class="er">
							<p>通城微信公众号</p>
							<p class="red">关注通城公众号的积分，换大礼</p>
						</div>
					</div>
				</div>
			</li> 
		</ul>
	</div>
</div>
<!---->
<div class="yiny yiny_gouwc">
	<div class="beij_center">
		<div class="dengl_logo">
			<a href="index.html"><img src="images/logo_1.png"></a>
			<h1>购物车</h1>
		</div>
	</div>
</div>
<div class="beij_center">
	<div class="cart-main-header clearfix">
		<div class="cart-col-1">
			<input type="checkbox" class="jdcheckbox" >
		</div>
		<div class="cart-col-2">全选</div><!-- $page.site 主站 团购 抢购   style -->
		<div class="cart-col-3">商品信息</div>
		<div class="cart-col-4">
			<div class="cart-good-real-price">单价</div>
		</div>
		<div class="cart-col-5">数量</div>
		<div class="cart-col-6">
			<div class="cart-good-amount">小计</div>
		</div>
		<div class="cart-col-7">操作</div>
	</div>
</div>
<div class="container">
	
</div>
<div class="jies_beij">
	<div class="beij_center over_dis">
		<div class="jies_ann_bei">
			<p>已选 <em></em> 件商品 总计（不含运费）：<span></span></p>
			<a href="tij_dingd.html" class="order_btn">去结算</a>
		</div>
	</div>
</div>

<div class="beij_center">
	<div class="investment_f">
	    <div class="investment_title">
	        <div class="ds_dg on_d">为您推荐</div>
	        <div class="ds_dg">最近预览</div> 
	    </div>
	    <div class="investment_con"> 
            <!----> 
			<div class="picScroll_left_s"  style="display: block;">
				<div class="hd">
					<a class="next next_you"></a>
					<ul></ul>
					<a class="prev prev_zuo"></a> 
				</div>
				<div class="bd">
					<ul class="picList">
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/lieb_tupi3.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/shangq_3.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/big_3.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/xiangqtu_1.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/lieb_tupi3.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/big_3.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/lieb_tupi1.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/lieb_tupi2.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
						<li>
							<div class="pic"><a href="#" target="_blank"><img src="images/lieb_tupi3.jpg" /></a></div>
							<div class="title">
								<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
								<div class="jiage_gouw"><span>¥2499.00</span></div>
								<a href="#" class="cart_scroll_btn">加入购物车</a>
							</div>
						</li>
					</ul>
				</div>
			</div> 
            <!----> 
	        <div class="picScroll_left_s" style="display: none;">
	            <div class="picScroll_left_s_dsl"> 
					<div class="dfgc">
						<ul class="picList">
							<li>
								<div class="pic"><a href="#" target="_blank"><img src="images/lieb_tupi3.jpg" /></a></div>
								<div class="title">
									<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
									<div class="jiage_gouw"><span>¥2499.00</span></div>
									<a href="#" class="cart_scroll_btn">加入购物车</a>
								</div>
							</li>
							<li>
								<div class="pic"><a href="#" target="_blank"><img src="images/big_3.jpg" /></a></div>
								<div class="title">
									<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
									<div class="jiage_gouw"><span>¥2499.00</span></div>
									<a href="#" class="cart_scroll_btn">加入购物车</a>
								</div>
							</li>
							<li>
								<div class="pic"><a href="#" target="_blank"><img src="images/lieb_tupi1.jpg" /></a></div>
								<div class="title">
									<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
									<div class="jiage_gouw"><span>¥2499.00</span></div>
									<a href="#" class="cart_scroll_btn">加入购物车</a>
								</div>
							</li>
							<li>
								<div class="pic"><a href="#" target="_blank"><img src="images/big_3.jpg" /></a></div>
								<div class="title">
									<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
									<div class="jiage_gouw"><span>¥2499.00</span></div>
									<a href="#" class="cart_scroll_btn">加入购物车</a>
								</div>
							</li> 
							<li>
								<div class="pic"><a href="#" target="_blank"><img src="images/shangq_3.jpg"></a></div>
								<div class="title">
									<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
									<div class="jiage_gouw"><span>¥2499.00</span></div>
									<a href="#" class="cart_scroll_btn">加入购物车</a>
								</div>
							</li>
							<li>
								<div class="pic"><a href="#" target="_blank"><img src="images/shangq_3.jpg"></a></div>
								<div class="title">
									<a href="#" target="_blank">喜芬妮春秋桑蚕丝长袖性感蕾丝花边女式睡衣家居服二</a>
									<div class="jiage_gouw"><span>¥2499.00</span></div>
									<a href="#" class="cart_scroll_btn">加入购物车</a>
								</div>
							</li>
						</ul>
					</div>
				</div> 
	        </div> 
	    </div>
	</div>
</div>

<!--底部-->
<div class="dib_beij dib_beij_ger_zhongx">
	<div class="dib_jvz_beij">
		<div class="shangp_baoz">
			<p>本地购物&nbsp;&nbsp;看得见的商品</p>
			<p class="beng1">正品行货&nbsp;&nbsp;购物无忧</p>
			<p class="beng2">低价实惠&nbsp;&nbsp;帮你省钱</p>
			<p class="beng3">本地直发&nbsp;&nbsp;专业配送</p>
		</div>
		<div class="zhongj_youx">
			<div class="lieb_daoh">
				<h4>物流配送</h4>
				<ul>
					<li><a href="#">配送查询</a></li>
					<li><a href="#">配送服务</a></li>
					<li><a href="#">配送费用</a></li>
					<li><a href="#">配送时效</a></li>
					<li><a href="#">签收与验货</a></li>
				</ul>
			</div>
			<div class="lieb_daoh">
				<h4>支付与账户</h4>
				<ul>
					<li><a href="#">货到付款</a></li>
					<li><a href="#">在线支付</a></li>
					<li><a href="#">门店支付</a></li> 
					<li><a href="zhangh_anq.html">账户安全</a></li>
				</ul>
			</div>
			<div class="lieb_daoh">
				<h4>购物帮助</h4>
				<ul>
					<li><a href="#">购物保障</a></li>
					<li><a href="#">购物流程</a></li>
					<li><a href="#">焦点问题</a></li>
					<li><a href="#">联系我们</a></li> 
				</ul>
			</div>
			<div class="lieb_daoh">
				<h4>售后服务</h4>
				<ul>
					<li><a href="#">退换货服务</a></li>
					<li><a href="#">退款说明</a></li>
					<li><a href="#">专业维修</a></li>
					<li><a href="#">延保服务</a></li>
					<li><a href="#">家电回收</a></li>
				</ul>
			</div>
			<div class="lieb_daoh">
				<div class="kef_dianh">
					<p>客服电话</p><span>400-6677-937</span>
				</div>
				<div class="kef_dianh kef_dianh_youx">
					<p>意见收集邮箱</p><p>Ask@wangid.com</p>
				</div>
			</div> 
			<div class="lieb_daoh lieb_daoh_you">
				<div class="erw_ma_beij">
					<div class="erw_m">
						<h1><img src="images/mb_wangid.png"></h1>
						<span>扫码下载通城客户端</span>
					</div>
					<div class="erw_m">
						<h1><img src="images/mb_wangid.png"></h1>
						<span>扫码下载通城客户端</span>
					</div>
				</div>
			</div> 
		</div>
		<div class="beia_hao">
			<p>京ICP备：14012449号 黔ICP证：B2-20140009号  </p>
			<p class="gonga_bei">京公网安备：11010602030054号</p>
			<div class="renz_">
				<span></span>
				<span class="span1"></span>
				<span class="span2"></span>
				<span class="span3"></span>
			</div>
		</div>
	</div>
</div>
<script src="./server/node_modules/axios/dist/axios.js"></script>

<script src="./js/cart.js"></script>
<script>
	class Cart{
		constructor(){
			this.checkLogin();
			this.getCartGoods();
			this.bindEve();
		}
		bindEve(){
			
			this.$('.container').addEventListener('click', this.distributeEve.bind(this));
			//全选框绑定
			this.$('.cart-main-header').addEventListener('click',this.clickAllChecked.bind(this));
		}
		$(dom,a = true){
        	return a?document.querySelector(dom):document.querySelectorAll(dom);
    	}
		//操作购物车界面用户 必须登录
		async checkLogin(){
			//获取token值
			const TOKEN = localStorage.getItem('token');
			//判断 是否过期
			// 判断是否登录过期
			axios.defaults.headers.common['authorization'] = TOKEN;
    		let userId = localStorage.getItem('user_id');
    		let { data, status } = await axios.get('http://localhost:8888/users/info/' + userId);
			// 如果没有token肯定没有登录
			if (!TOKEN || data.code == 401) {
      			location.assign('./dengl.html?ReturnUrl=./gouw_che.html');
   	 		}
		}

		//获取 购物车中的数据
		async getCartGoods(){
			const TOKEN = localStorage.getItem('token');
			let userId = localStorage.getItem('user_id');
			axios.defaults.headers.common['authorization'] = TOKEN;
			let { data, status } = await axios.get('http://localhost:8888/cart/list?id=' + userId);
			if (status == 200) {
				// 判断是否超过有效期,过期则跳转到登录页面
      			if (data.code == 401) location.assign('./dengl.html?ReturnUrl=./gouw_che.html')
				// 判断接口的状态
				if (data.code == 1) {

					// console.log(data.cart);
					let html =``;
					data.cart.forEach(goods => {
						html +=`<div class="spList" data-id="${goods.goods_id}">
							<div class="cart-shop-goods">
								<div class="cart-shop-good shplist" data-id="${goods.goods_id}">
									<div class="cart-col-1">
										<input type="checkbox" id="slbox" class="jdcheckbox" >
									</div>
									<div class="cart-col-2" style="height: 82px;">
										<a href="" target="_blank" class="g-img"><img src="${goods.img_small_logo}" alt=""></a>
									</div>
									<div class="fl houj_c"> 
										<div class="cart-dfsg"><div class="cart-good-name"><a href="#" target="_blank">${goods.title}</a></div></div>
										<div class="cart-good-pro"></div>
										<div class="cart-col-4"><div class="cart-good-real-price "><!--主品-->¥&nbsp;${goods.price}</div><div class="red"></div></div>
										<div class="cart-col-5">
											<div class="gui-count cart-count" >
												<a href="#" gui-count-sub="" class="gui-count-btn gui-count-sub gui-count-disabled">-</a>
												<a href="#" gui-count-add="" class="gui-count-btn gui-count-add">+</a>
												<div class="gui-count-input"><input dytest="" class="shpnum" type="text" value="${goods.cart_number}"></div>
											</div>
										</div>
										<div class="cart-col-6 ">
										<div class="cart-good-amount">¥&nbsp;<span class="shpprice">${goods.price * goods.cart_number}</span></div><!-- 重量展示(只展示全球百货的重量) --></div>
									</div>
									<div class="cart-col-7">
										<div class="cart-good-fun delfixed">
											<a href="#">删除</a>
										</div>
										<div class="cart-good-fun">
											<a href="#">移入收藏夹</a>
										</div>
									</div>
								</div>
							</div>
						</div>`;
					});
					this.$('.container').innerHTML = html;
				}
			}
		} 
		//将单个商品的操作都委托给container
		//直接结构赋值,获取事件源
		/*************删除事件的委托  和  判断点击是否是单个商品的选中按钮****************/ 
		distributeEve({ target }) {
			// 判断是否有div为删除按钮
			if (target.parentNode.classList.contains('delfixed')) {
				this.delGoods(target);//删除数据函数
			}
			//单个商品，选中同时 全选 选中
			this.getOneGoodsCheck(target);

			
		}

		//删除数据
		delGoods(target) {
			let that = this;
			//确认是否删除
			let layerIndex = layer.confirm('你要残忍抛弃我吗?', {
				title: '删除提示'
			}, function () {
				// console.log('确定了...');
				// 获取商品id
				let ulObj = target.parentNode.parentNode.parentNode;
				console.log(ulObj);
				let id = ulObj.dataset.id;
				console.log(id);
				// 获取用户id
				let userId = localStorage.getItem('user_id');
				//发送ajax删除商品数据
				console.log(id, userId);
				axios.get('http://localhost:8888/cart/remove?id=' + userId + '&goodsId=' + id)
					.then(res => {
						let { data, status } = res;
						// console.log(data, status);
						if (data.code == 1) {  // 删除成功,则关闭弹出框,删除页面中的商品对应的ul
							// 关闭确认框
							layer.close(layerIndex);
							// 提示删除成功
							layer.msg('商品删除成功');
							//在页面中删除节点
							ulObj.remove();
							// 统计商品数量和价格的方法
							// console.log(this);
							that.getNumPriceGoods();
					}
				});
			})
  		}

		// selectorAll({target}){
		// 	if (target.id.contains('slbox')) {
		// 		// console.log(target);
		// 		// 统计商品数量和价格的方法
		// 		this.getNumPriceGoods()
		// 	}
		// }
		// 单个商品的选中按钮的回调
		getOneGoodsCheck(target) {
			//如果是取消,则直接让全选取消
			// console.log(this.$('.cart-col-1 input'));
			if (!target.checked) {
					this.$('.cart-col-1 input').checked = false;
					return;
			}
			// console.log(this.$('#slbox'));
			// 如果点击的是选中,则返回true
			if (target.checked) {
				// 选中页面中,没有被选中的商品
				// console.log(this.$('.good-checkbox'));
				let res = Array.from(this.$('.cart-col-1 input')).find(checkbox => {
					// 没有被选中,状态为false
					// console.log(checkbox.checked);
					return !checkbox.checked
				});
				// console.log(res);
				// 如果返回undefined,则是页面中都被选中
				if (!res) this.$('.cart-col-1 input').checked = true;
			}
		}

		// 获取页面中,所有选中商品的价格和数量
		getNumPriceGoods() {
			let goods = document.querySelectorAll('.shplist');
			// console.log(goods);
			// 迭代器
			// let res = goods[Symbol.iterator]();
			// console.log(res.next());
			// res.next()
			// 保存数量和价格
			let totalNum = 0;
			let totalPrice = 0;
			// console.log(goods);

			goods.forEach(one => {
			// console.log(one.firstElementChild.firstElementChild);
			// 只统计本选中的商品的价格和数量

			if (one.firstElementChild.firstElementChild.checked) {
				// console.log(one);
				// 数量的获取
				console.log(one.querySelector('.shpnum').value);
				totalNum = one.querySelector('.shpnum').value - 0 + totalNum;
				// console.log(one.querySelector('.sum').innerHTML);
				totalPrice = one.querySelector('.shpprice').innerHTML - 0 + totalPrice;
			}

			});
			// console.log(totalNum, totalPrice);
			// 设置到总计上
			this.$('.jies_ann_bei em').innerHTML = totalNum;
			this.$('.jies_ann_bei span').innerHTML = totalPrice;
  		}
		// 全选的实现
		clickAllChecked(eve) {
			// console.log(eve.target);
			// 获取全选按钮的状态
			let checked = eve.target.checked;
			console.log(checked);
			this.oneGoodsCheck(checked);
			// 统计数量和价格的方法
			this.getNumPriceGoods();
		}

		// 设置单个商品的选中状态
		oneGoodsCheck(checkStatus) {
			let goodsList = this.$('#slbox',false);
			// console.log(goodsList, checkStatus);
			goodsList.forEach(ul => {
			// console.log(ul);
			// 找到单个商品的复选框
				ul.checked = checkStatus;
			})

		}

	}
	new Cart;
</script>









		
<script src="./lib/jquery-2.2.4.js"></script>
<script src="./lib/layer/layer.js"></script>
</body>
</html>
